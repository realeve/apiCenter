var previewSidebar=function(){var e=App.getResponsiveBreakpoint("md"),a=function(){var e=$("#menuPreviewDetail");e.hasClass("page-sidebar-fixed")&&$("#menuPreviewDetail .page-sidebar").on("mouseenter",function(){e.hasClass("page-sidebar-closed")&&$(this).find(".page-sidebar-menu").removeClass("page-sidebar-menu-closed")}).on("mouseleave",function(){e.hasClass("page-sidebar-closed")&&$(this).find(".page-sidebar-menu").addClass("page-sidebar-menu-closed")})},t=function(){var a,t=$("#menuPreviewDetail .page-content"),n=$("#menuPreviewDetail .page-sidebar"),s=$("#menuPreviewDetail");if(s.hasClass("page-footer-fixed")===!0&&s.hasClass("page-sidebar-fixed")===!1){var l=App.getViewPort().height-$(".page-footer").outerHeight()-$(".page-header").outerHeight();t.height()<l&&t.attr("style","min-height:"+l+"px")}else{if(s.hasClass("page-sidebar-fixed"))a=i(),s.hasClass("page-footer-fixed")===!1&&(a-=$(".page-footer").outerHeight());else{var r=$(".page-header").outerHeight(),d=$(".page-footer").outerHeight();a=App.getViewPort().width<e?App.getViewPort().height-r-d:n.height()+20,a+r+d<=App.getViewPort().height&&(a=App.getViewPort().height-r-d)}t.attr("style","min-height:"+a+"px")}},i=function(){var e=App.getViewPort().height-$(".page-header").outerHeight(!0);return $("body").hasClass("page-footer-fixed")&&(e-=$(".page-footer").outerHeight()),e},n=function(){$("#menuPreviewDetail .page-sidebar-menu").on("click","li > a.nav-toggle, li > a > span.nav-toggle",function(a){var i=$(this).closest(".nav-item").children(".nav-link");if(!(App.getViewPort().width>=e&&!$("#menuPreviewDetail .page-sidebar-menu").attr("data-initialized")&&$("body").hasClass("page-sidebar-closed")&&1===i.parent("li").parent(".page-sidebar-menu").size())){var n=i.next().hasClass("sub-menu");if(!(App.getViewPort().width>=e&&1===i.parents("#menuPreviewDetail .page-sidebar-menu-hover-submenu").size())){if(n===!1)return void(App.getViewPort().width<e&&$("#menuPreviewDetail .page-sidebar").hasClass("in")&&$(".page-header .responsive-toggler").click());if(!i.next().hasClass("sub-menu always-open")){var s=i.parent().parent(),l=i,r=$("#menuPreviewDetail .page-sidebar-menu"),d=i.next(),o=r.data("auto-scroll"),u=parseInt(r.data("slide-speed")),c=r.data("keep-expanded");c||(s.children("li.open").children("a").children(".arrow").removeClass("open"),s.children("li.open").children(".sub-menu:not(.always-open)").slideUp(u),s.children("li.open").removeClass("open"));var m=-200;d.is(":visible")?($(".arrow",l).removeClass("open"),l.parent().removeClass("open"),d.slideUp(u,function(){o===!0&&$("#menuPreviewDetail").hasClass("page-sidebar-closed")===!1&&($("#menuPreviewDetail").hasClass("page-sidebar-fixed")?r.slimScroll({scrollTo:l.position().top}):App.scrollTo(l,m)),t()})):n&&($(".arrow",l).addClass("open"),l.parent().addClass("open"),d.slideDown(u,function(){o===!0&&$("#menuPreviewDetail").hasClass("page-sidebar-closed")===!1&&($("#menuPreviewDetail").hasClass("page-sidebar-fixed")?r.slimScroll({scrollTo:l.position().top}):App.scrollTo(l,m)),t()})),a.preventDefault()}}}}),$("#menuPreviewDetail").on("click",".page-header-fixed-mobile .page-header .responsive-toggler",function(){App.scrollTop()}),a()},s=function(){var a=$("#menuPreviewDetail .page-sidebar-menu");return App.destroySlimScroll(a),0===$("#menuPreviewDetail .page-sidebar-fixed").size()?void t():void(App.getViewPort().width>=e&&(a.attr("data-height",i()),App.initSlimScroll(a),t()))},l=function(){var e=$("#menuPreviewDetail");$("#menuPreviewDetail").on("click",".sidebar-toggler",function(a){var t=($("#menuPreviewDetail .page-sidebar"),$("#menuPreviewDetail .page-sidebar-menu"));e.hasClass("page-sidebar-closed")?(e.removeClass("page-sidebar-closed"),t.removeClass("page-sidebar-menu-closed"),$.cookie&&$.cookie("sidebar_closed","0")):(e.addClass("page-sidebar-closed"),t.addClass("page-sidebar-menu-closed"),e.hasClass("page-sidebar-fixed")&&t.trigger("mouseleave")),$(window).trigger("resize")})};return{init:function(){s(),n(),l(),App.addResizeHandler(s)}}}(),customizeMenu=function(){function e(e){var a="<li>";return a+='<div class="task-checkbox">',a+='        <input type="hidden"  value="'+e.id+'"/>',a+='        <div class="checker"><span><input type="checkbox" class="liChild" value="'+e.id+'"/></span></div>',a+="    </div>",a+='    <div class="task-title">',a+='        <span class="task-title-sp">',a+="        <a>"+e.name+" </a></span>",a+="    </div>",a+='    <div class="task-config">',a+='        <div class="task-config-btn btn-group">',a+='            <a class="btn btn-xs default" href="#" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">',a+='            <i class="fa fa-cog"></i><i class="fa fa-angle-down"></i>',a+="            </a>",a+='             <ul class="dropdown-menu pull-right">',a+='                <li class="edit"  data-id="'+e.id+'">',a+='                    <a href="javascript:;">',a+='                    <i class="fa fa-pencil"></i> 编辑 </a>',a+="                </li>",a+="            </ul>",a+="        </div>",a+="    </div>",a+="</li>"}function a(){$('#menuEdit [name="name"]').val(""),$('#menuEdit [name="url"]').val(""),$('#menuEdit [name="share"]').parent().removeClass("checked"),$('[data-target="#icon_library"]').html(""),SetSelect2Val("menuDetail",-1)}var t=$(".username").data("uid"),i=[],n=[],s=function(){$("#menuDetail .task-list .task-checkbox").parent().removeClass("task-done"),$("#menuDetail .task-list .liChild").parent().removeClass("checked")},l=function(){return{init:function(){function n(e,a){var t,i='<option value="-1"></option>';for(t=0;t<a.rows;t++)i+='<option value="'+a.data[t].id+'" data-userid="'+a.data[t].user_id+'" data-share="'+a.data[t].share+"\" data-seg='"+GBK2UTF(a.data[t].segment_json)+"'>"+a.data[t].name+"</option>";$("select[name='"+e+"']").html(i)}function l(){s()}function r(){var e=getRootPath()+"/api/insert",a={tbl:TBL.SETTINGS_MENULIST,name:$('#newMenu [name="menuName"]').val(),user_id:t,share:"checked"===$('#newMenu [name="share"]').attr("checked")?1:0,utf2gbk:["name"],hide:0};return""===a.name?void bsTips("菜单名不能为空"):void $.post(e,a,function(e,i){var n=$.parseJSON(e);"success"==i?($('select[name="menu_list"]').append('<option value="'+n.id+'" data-share="'+a.share+'" data-userid="'+t+'">'+a.name+"</option>"),$('#newMenu [name="menuName"]').val(""),$('#newMenu [name="share"]').parent().removeClass("checked"),a.share?$('#menuList [name="share"]').parent().addClass("checked"):$('#menuList [name="share"]').parent().removeClass("checked"),$('#newMenu [name="cancel"]').click(),l(),bsTips("菜单项添加成功",2)):(bsTips("添加失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e)))})}function d(){var e=getRootPath()+"/api/update",a={tbl:TBL.SETTINGS_MENULIST,name:$('#newMenu [name="menuName"]').val(),id:$('#newMenu [name="save"]').data("id"),share:"checked"===$('#newMenu [name="share"]').attr("checked")?1:0,utf2gbk:["name"]};return""===a.name?void bsTips("菜单名不能为空"):void $.post(e,a,function(e,t){$.parseJSON(e);"success"==t?($('select[name="menu_list"]').find("option:selected").data("share",a.share).text(a.name),$(".select2").select2({width:null,placeholder:"请选择要编辑的菜单"}),a.share?$('#menuList [name="share"]').parent().addClass("checked"):$('#menuList [name="share"]').parent().removeClass("checked"),$('#newMenu [name="cancel"]').click(),bsTips("菜单项更新成功",2)):(bsTips("更新失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e)))})}function o(){return 15==t?!0:$('select[name="menu_list"]').val()<1?(bsTips("默认菜单不允许修改"),!1):$('select[name="menu_list"]').find("option:selected").data("userid")!=t?(bsTips("其它人的菜单不允许修改"),!1):!0}function u(){var e=getRootPath()+"/api/update";if(!o())return void bsTips("菜单信息未保存",1);var a={tbl:TBL.SETTINGS_MENULIST,id:$('#menuOper [name="save"]').data("id"),segment_json:UTF2GBK($("#menuPreviewList_output").val()),segment_html:UTF2GBK($("#menuPreviewDetail").html())};$.post(e,a,function(e,a){$('select[name="menu_list"]').find("option:selected").data("seg",$("#menuPreviewList_output").val()),bsTips("菜单信息保存成功",2)})}function c(e){$('#newMenu [name="save"]').attr("disabled",!1),"add"==e?($("#newMenu h4").text("添加新菜单"),$('#newMenu [name="menuName"]').val(""),$('#newMenu [name="share"]').parent().removeClass("checked"),$('#newMenu [name="save"]').text("添加菜单"),$('#newMenu [name="save"]').data("mode","add")):($("#newMenu h4").text("编辑菜单"),$('#newMenu [name="menuName"]').val(GetSelect2Text("menu_list")),1==$('select[name="menu_list"]').find("option:selected").data("share")?$('#newMenu [name="share"]').parent().addClass("checked"):$('#newMenu [name="share"]').parent().removeClass("checked"),$('#newMenu [name="save"]').text("更新菜单").data("mode","edit").data("id",$('select[name="menu_list"]').val()))}function m(e){return"http://"!==jsLeft(e.url,7)&&"javascript"!==jsLeft(e.url,10)&&"/"!==jsLeft(e.url,1)&&(e.url="/"+e.url),'<option value="'+e.id+'" data-userid="'+e.user_id+'" data-share="'+e.share+'" data-url="'+e.url+'" data-type="'+e.type+'" data-icon="'+e.icon+'">'+e.name+"</option>"}function p(){var a=getRootPath(1)+"/api/Api?Token="+config.TOKEN+"&ID=7&M=0&uid="+t+"&cache=1";i=ReadData(a);var n=$('select[name="menuDetail"]');$("#menuPreviewList").append('<ol class="dd-list"></ol>'),a='<option value="-1"></option>';var s=0;i.data.map(function(t,i){s%2===0?$("#menuDetail .task-list").last().append(e(t)):$("#menuDetail .task-list").first().append(e(t)),a+=m(t),s++}),n.html(a),$("li.del a").confirmation()}(function(){1==getUrlParam("debug")&&$("#menuPreviewList_output").parents(".portlet").removeClass("hide");var e=getRootPath(1)+"/api/Api?Token="+config.TOKEN+"&ID=6&M=0&uid="+t,a=ReadData(e);n("menu_list",a),$(".page-header .dropdown-quick-sidebar-toggler").hide(),initSelect2(),p()})();$('#newMenu [name="save"]').on("click",function(){"add"==$(this).data("mode")?r():d()}),$('#menuList [name="share"]').change(function(){var e=getRootPath()+"/api/update",a=$(this),t=$('select[name="menu_list"]'),i={tbl:TBL.SETTINGS_MENULIST,share:"checked"===$(this).attr("checked")?0:1,id:t.val()};return o()?void $.post(e,i,function(e,n){$.parseJSON(e);"success"==n?(bsTips("菜单项分享状态修改成功",2),1==i.share?(t.find("option:selected").data("share",1),a.parent().addClass("checked")):(t.find("option:selected").data("share",0),a.parent().removeClass("checked"))):(bsTips("修改失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e)))}):void(i.id>=0&&a.parent().addClass("checked"))}),$("body").on("confirmed.bs.confirmation",'#menuOper [name="del"]',function(){var e=getRootPath()+"/api/update";if(o()){var a={tbl:TBL.SETTINGS_MENULIST,id:$(this).data("id"),hide:1};$.post(e,a,function(e,a){"success"==a?($('select[name="menu_list"]').find("option:selected").remove(),SetSelect2Val("menu_list",-1),l(),bsTips("菜单项删除成功",2)):(bsTips("删除失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e)))})}}),$("body").on("canceled.bs.confirmation",'#menuOper [name="del"]',function(){$('#menuOper [name="del"]').click()}),$("#menuOper").on("click",'[name="save"]',function(){u()}),$("#menuOper").on("click",'[name="active"]',function(){var e=getRootPath()+"/api/update",a={tbl:TBL.USR,id:t,default_menu_id:$('select[name="menu_list"]').val()};$.post(e,a,function(e,a){localStorage.settings_default_menu=UTF2GBK($("#menuPreviewDetail").html()),loadMenuSettings(),bsTips("菜单项已成功设置",2)})}),$('#menuList [name="add"]').click(function(){c("add")}),$('#menuList [name="rename"]').click(function(){return o()?void c("edit"):void $('#newMenu [name="save"]').attr("disabled",!0)}),$('select[name="menuDetail"]').on("change",function(){if(-1==$(this).val())return $('#menuEdit [name="name"]').val(""),$('#menuEdit [name="url"]').val(""),$('#menuEdit [name="share"]').parent().removeClass("checked"),void $('[data-target="#icon_library"]').html("");var e={};e.val=$(this).val(),e.name=GetSelect2Text("menuDetail");var i=$('select[name="menuDetail"]').find('option[value="'+e.val+'"]');return e.url=i.data("url"),e.userid=i.data("userid"),e.share=i.data("share"),e.icon=i.data("icon"),e.userid!=t?(bsTips("其它人的菜单不允许修改"),a(),!1):($('input[name="name"]').val(e.name),$('input[name="url"]').val(e.url),"1"==e.share?$('#menuEdit [name="share"]').parent().addClass("checked"):$('#menuEdit [name="share"]').parent().removeClass("checked"),void("undefined"!==e.icon&&$('[data-target="#icon_library"]').html(GBK2UTF(e.icon))))}),$("#menuDetail").on("click","li.edit",function(){SetSelect2Val("menuDetail",$(this).data("id"))}),$("#icon_library .bs-glyphicons li").click(function(){$('[data-target="#icon_library"]').html($(this).html()),$("#icon_library .modal-footer button").click()})}}}(),r=function(e){var a=e.length?e:$(e.target),t=a.data("output");window.JSON?t.val(window.JSON.stringify(a.nestable("serialize"))):t.val("JSON browser support required for this demo.")},d=function(e,a,t){function i(e,a){return a&&(a+='<ol class="dd-list">'),e.map(function(e,t){$('#menuDetail .task-list input[value="'+e.id+'"]').parents("li").addClass("task-done"),$("#menuDetail .task-list .liChild[value="+e.id+"]").parent().addClass("checked"),a+='<li class="dd-item" data-id="'+e.id+'">',"undefined"!=typeof e.children?(a+='<button data-action="collapse" type="button" style="display: block;">Collapse</button>',a+='<button data-action="expand" type="button" style="display: none;">Expand</button>',a+='      <div class="dd-handle"> '+n[e.id].name+" </div>",a=i(e.children,a)):a+='      <div class="dd-handle"> '+n[e.id].name+" </div>",a+=" </li>"}),a+"</ol>"}function s(e,a,t){a&&(a+='<ul class="sub-menu">');var i;return e.map(function(e,l){"undefined"==n[e.id].icon&&(n[e.id].icon="%20"),i=GBK2UTF(n[e.id].icon),"undefined"!=typeof e.children?(a+='<li class="nav-item" data-id="'+e.id+'">',a+='      <a href="'+n[e.id].url+'" class="nav-link nav-toggle"> '+i+' <span class="title">'+n[e.id].name,a=s(e.children,a+'</span><span class="arrow "></span>',t+1),a+="</a>"):0===t?(a+='<li class="heading" data-id="'+e.id+'">',a+='      <h3 style="font-size:1.3em;">'+i+n[e.id].name+"</h3>"):(a+='<li class="nav-item" data-id="'+e.id+'">',a+='      <a href="'+n[e.id].url+'" class="nav-link nav-toggle"> '+i+' <span class="title">'+n[e.id].name+"</span></a>"),a+="</li>"}),a+"</ul>"}if(1==t){if(0===a.length)return void $(e).html('<ol class="dd-list"></ol>');str=jsOnRight(i(a,""),5),$(e).html('<ol class="dd-list">'+str+"</ol>")}else{if(0===a.length)return void $(e).html("");str=jsOnRight(s(a,"",0),5),$(e).html(str),$(e).find("a").map(function(e,a){""===$(this).text().trim()&&$(this).remove()})}},o=function(e){d("#menuPreviewDetail",e,0)},u=function(){return{init:function(){$(".task-list").on("click",".task-checkbox,.task-title",function(e){var a=$(this).parent().find(".liChild"),t=$(this).parents("li"),i=a.val();if(a.parent().hasClass("checked")){t.removeClass("task-done"),a.parent().removeClass("checked");var n=$('#menuPreviewList .dd-item[data-id="'+i+'"]'),l=$('#menuPreviewDetail [data-id="'+i+'"]'),u=$("#menuPreviewList li[data-id="+i+"] ol");1==n.parent().find("li").length?1==$("#menuPreviewDetail li").length?(l.remove(),n.remove()):(l.parent().remove(),n.parent().remove()):(n.remove(),l.remove()),u.length&&(r($("#menuPreviewList").data("output",$("#menuPreviewList_output"))),s(),d("#menuPreviewList",$.parseJSON($("#menuPreviewList_output").val()),1))}else{t.addClass("task-done"),a.parent().addClass("checked");var c=$.trim(t.find(".task-title").text()),m='<li class="dd-item" data-id="'+i+'">      <div class="dd-handle"> '+c+" </div> </li>",p='<li class="nav-item" data-id="'+i+'">      <a href="javascript:;" class="nav-link nav-toggle"> <span class="title">'+c+"</span> </a> </li>";$("#menuPreviewList ol").first().append(m),$("#menuPreviewDetail").append(p)}r($("#menuPreviewList").data("output",$("#menuPreviewList_output"))),o($.parseJSON($("#menuPreviewList_output").val()))})}}}(),c=function(){return{init:function(){function i(){return{tbl:TBL.SETTINGS_MENUDETAIL,utf2gbk:["name","url"],name:$('#menuEdit [name="name"]').val(),url:$('#menuEdit [name="url"]').val().trim(),share:"checked"===$('#menuEdit [name="share"]').attr("checked")?1:0,icon:UTF2GBK($('[data-target="#icon_library"]').html().trim()+" ")}}function s(e){var t=$("#menuDetail .liChild[value="+e+"]"),i=t.parents("li"),n=t.val();if(t.parent().hasClass("checked")){i.removeClass("task-done"),t.parent().removeClass("checked");var s=$('#menuPreviewList .dd-item[data-id="'+n+'"]'),l=$('#menuPreviewDetail [data-id="'+n+'"]'),d=$("#menuPreviewList li[data-id="+n+"] ol");d.length&&$("#menuPreviewList ol").first().append(d.first().html()),1==s.parent().find("li").length?1==$("#menuPreviewDetail li").length?(l.remove(),s.remove()):(l.parent().remove(),s.parent().remove()):(s.remove(),l.remove()),r($("#menuPreviewList").data("output",$("#menuPreviewList_output"))),o($.parseJSON($("#menuPreviewList_output").val()))}a()}$("#menuEdit").on("click",'button[name="add"]',function(){var s=i();return s.user_id=t,s.type=1,s.hide=0,""===s.name?void bsTips("菜单名不能为空"):(""===s.url&&(s.url="javascript:;"),$.ajax({url:getRootPath()+"/api/insert",type:"POST",data:s}).done(function(a){bsTips("菜单增加成功",1);var t,i=$.parseJSON(a),l={id:i.id,name:s.name};t=$("#menuDetail .task-list").last().find("li").length<$("#menuDetail .task-list").first().find("li").length?$("#menuDetail .task-list").last():$("#menuDetail .task-list").first(),t.append(e(l)),n[i.id]={name:s.name,url:s.url,icon:s.icon};var r='<option value="'+l.id+'" data-userid="'+s.user_id+'" data-share="'+s.share+'" data-url="javascript:;" data-type="'+s.type+' data-icon="'+s.icon+'">'+l.name+"</option>";$('select[name="menuDetail"]').append(r)}).fail(function(e){bsTips("增加"+JSON.stringify(s)),infoTips(JSON.stringify(s))}),void a())}),$("#menuEdit").on("click",'button[name="edit"]',function(){var e=i();return e.id=$('select[name="menuDetail"]').val(),""===e.name?void bsTips("菜单名不能为空"):(""===e.url&&(e.url="javascript:;"),$.ajax({url:getRootPath()+"/api/update",type:"POST",data:e}).done(function(a){bsTips("菜单修改成功",1),$("#menuDetail .liChild[value="+e.id+"]").parents("li").find(".task-title-sp a").text(e.name),n[e.id].name=e.name,n[e.id].url=e.url,n[e.id].icon=e.icon,$("#menuPreview li[data-id="+e.id+"] .dd-handle").first().text(e.name),$("#menuPreview li[data-id="+e.id+"] .nav-link").first().html(GBK2UTF(e.icon)+e.name).attr("href",e.url),$('select[name="menuDetail"] option[value="'+e.id+'"]').data("share",e.share).data("url",e.url).data("type",e.type).data("icon",e.icon).text(e.name),$('select[name="menuDetail"]').select2()}).fail(function(a){bsTips("修改"+JSON.stringify(e)),infoTips(JSON.stringify(e))}),void a())}),$("#menuEdit").on("click",'button[name="hide"]',function(){var e=i();e.id=$('select[name="menuDetail"]').val(),e.hide=1,$.ajax({url:getRootPath()+"/api/update",type:"POST",data:e}).done(function(a){bsTips("菜单删除成功",1),s(e.id),$("#menuDetail .liChild[value="+e.id+"]").parents("li").remove(),delete n[e.id],$('select[name="menuDetail"] option[value="'+e.id+'"]').remove(),$('select[name="menuDetail"]').select2()}).fail(function(a){bsTips("删除"+JSON.stringify(e)),infoTips(JSON.stringify(e))})})}}}(),m=function(){return{init:function(){function e(e){var a=[];return e.map(function(e,t){a[e.id]={},a[e.id].name=e.name,a[e.id].url=e.url,a[e.id].icon=e.icon}),a}n=e(i.data),$('select[name="menu_list"]').change(function(){var e=$(this).val(),a=$(this).find("option:selected");return"1"==a.data("share")?$('#menuList [name="share"]').parent().addClass("checked"):$('#menuList [name="share"]').parent().removeClass("checked"),$('#menuOper [name="del"],#menuOper [name="rename"],#menuOper [name="save"]').data("id",e),s(),-1==e?void bsTips("复制当前调整区域菜单内容。"):(d("#menuPreviewList",a.data("seg"),1),r($("#menuPreviewList").data("output",$("#menuPreviewList_output"))),void o(a.data("seg")))}),$("#menuPreviewList").nestable({group:1}).on("change",function(){r($("#menuPreviewList").data("output",$("#menuPreviewList_output"))),o($.parseJSON($("#menuPreviewList_output").val()))}),$("#menuPreviewList_menu").on("click",function(e){var a=$(e.target),t=a.data("action");"expand-all"===t&&$(".dd").nestable("expandAll"),"collapse-all"===t&&$(".dd").nestable("collapseAll")})}}}(),p=function(){var e=function(){$("#newMenu").draggable({handle:".modal-header"})};return{init:function(){e()}}}();return{init:function(){l.init(),u.init(),c.init(),m.init(),p.init()}}}();jQuery(document).ready(function(){initDom(),customizeMenu.init()}),jQuery(window).resize(function(){HeadFix()});