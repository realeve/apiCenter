function reLogin(){window.location.href=getRootPath()+"/welcome/lockscreen"}var handleAvatar=function(){var e,a=$(".username").data("avatar"),t=function(){return getRootPath(1)+"/demo/upload/"+a+".jpg?"+Date.parse(new Date)},r=function(e){"undefined"==typeof e&&(e=a);var t=getRootPath(1)+"/demo/avatar/"+e+".jpg?"+Date.parse(new Date);$(".profile-userpic img").attr("src",t),$(".username").parent().find("img").attr("src",t),localStorage.setItem("avatarUrl",t)},n=function(){function n(e){$("#crop_x").val(e.x),$("#crop_y").val(e.y),$("#crop_w").val(e.w),$("#crop_h").val(e.h),i(e)}function s(){var e=getRootPath()+"/api/update",a={tbl:TBL.USR,id:$(".username").data("uid"),set_avatar:1};$.ajax({url:e,type:"POST",data:a,success:function(e){var a=$.parseJSON(e);bsTips(a.message,a.type),setTimeout(reLogin,3e3)},error:function(e){bsTips("更新数据失败，请稍后重试或联系管理员!"),infoTips(JSON.stringify(e))}})}function i(e){if(parseInt(e.w)>0){var a=l/e.w,t=f/e.h;d.css({width:Math.round(a*o)+"px",height:Math.round(t*c)+"px",marginLeft:"-"+Math.round(a*e.x)+"px",marginTop:"-"+Math.round(t*e.y)+"px"})}}var o,c,u=$("#preview-pane"),p=$("#preview-pane .preview-container"),d=$("#preview-pane .preview-container img"),l=p.width(),f=p.height();$("#demo8").Jcrop({aspectRatio:1,onSelect:n,onChange:i},function(){var a=this.getBounds();o=a[0],c=a[1],e=this,u.appendTo(e.ui.holder)}),$("#saveAvatar").on("click",function(){if(""==$("#crop_w").val())return bsTips("请选择头像裁切区域后再保存."),!1;$.ajax({url:getRootPath(1)+"/demo/cropImage.php",data:{src:t(),filename:a,x:$("#crop_x").val(),y:$("#crop_y").val(),w:$("#crop_w").val(),h:$("#crop_h").val()},success:function(e){var a=$.parseJSON(e);bsTips(a.msg,a.status),r(),s()},error:function(e){console.log(e)}})})},s=function(){var a='<div id="preview-pane">\n<div class="preview-container">\n<img name="hisAvatar" src="../../assets/pages/media/profile/Avatar_none.jpg" class="jcrop-preview" alt="Preview" />\n</div>\n</div>';$("#demo8_form").parent().prepend(a),$('[name="hisAvatar"]').attr("src",t()),"undefined"!=typeof e&&e.destroy(),n()};(function(){var e=1==$(".username").data("set-avatar");e?s():bsTips("尚未上传头像文件，请选择图像并上传")})();$("#submitAvatar").on("click",function(){var e=new FormData($("#avatarForm")[0]);e.append("avatarName",a),$.ajax({url:getRootPath(1)+"/demo/upload_avatar.php",type:"POST",data:e,async:!1,cache:!1,contentType:!1,processData:!1,success:function(e){var a=$.parseJSON(e);bsTips(a.msg,a.status),s()},error:function(e){infoTips(e)}})});var i=function(){$(window).width()<=1024&&$(window).width()>=678?$(".responsive-1024").each(function(){$(this).attr("data-class",$(this).attr("class")),$(this).attr("class","responsive-1024 col-md-12")}):$(".responsive-1024").each(function(){$(this).attr("data-class")&&($(this).attr("class",$(this).attr("data-class")),$(this).removeAttr("data-class"))})};return{init:function(){jQuery().Jcrop&&(App.addResizeHandler(i),i())}}}(),handleBasicInfo=function(){function e(){var e=getRootPath(1)+"/api/Api?Token="+config.TOKEN+"&ID=2&M=3&u="+$(".username").text().trim(),a=ReadData(e),t=a.data[0];$(".profile-usertitle-name").text(t[0]),$(".profile-usertitle-job").text(t[2]),$('input[name="FullName"]').val(t[0]),SetSelectVal("department",t[1]),$('input[name="Phone"]').val(t[3]),$('input[name="Email"]').val(t[4])}(function(){var e=getRootPath(1)+"/api/Api?Token="+config.TOKEN+"&ID=3&M=3",a=ReadData(e);InitSelect("department",a)})();$('[name="restore"]').on("click",function(){e()}),$('[name="saveUserInfo"]').on("click",function(){var e=getRootPath()+"/api/update",a=getFormData("userInfo");a.tbl=TBL.USR,a.utf2gbk=["FullName"],a.id=$(".username").data("uid"),$.ajax({url:e,type:"POST",data:a,success:function(e){var a=$.parseJSON(e);bsTips(a.message,a.type)},error:function(e){bsTips("更新数据失败，请稍后重试或联系管理员!"),infoTips(JSON.stringify(e))}})});(function(){$('form[name="userInfo"]').validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:{FullName:{required:!0,minlength:2},Phone:{required:!0,number:!0,minlength:4},department:{required:!0,min:1},Email:{required:!0,email:!0}},messages:{FullName:{required:"姓名不能为空."},Phone:{required:"电话不能为空."},Email:{required:"Email是您重置密码的唯一凭证."},department:{required:"请选择部门信息",min:"请选择部门信息"}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}})})();return{init:e}}(),handleUserPassword=function(e){function a(e){var a=getRootPath(1)+"/api/Api?Token="+config.TOKEN+"&ID=4&M=3&uid="+$(".username").data("uid")+"&psw="+e,t=ReadData(a);return t.rows}$('[name="changePsw"]').on("click",function(){var e=getFormData("userPsw"),t={};return $.ajax({url:getRootPath()+"/api/md5?oldPsw="+e.oldPsw+"&newPsw="+e.newPsw,async:!1,success:function(e){var a=$.parseJSON(e);t={UserPassword:a.oldPsw,newPsw:a.newPsw}},error:function(e){bsTips("密码校验失败，请稍后重试或联系管理员!"),infoTips(JSON.stringify(e))}}),a(t.UserPassword)?(t.id=$(".username").data("uid"),void $.ajax({url:getRootPath()+"/settings/updatepsw",type:"GET",data:t,success:function(e){var a=$.parseJSON(e);bsTips(a.message+"<br>请3秒钟之后重新登录",a.type),setTimeout(reLogin,3e3)},error:function(e){bsTips("更新数据失败，请稍后重试或联系管理员!"),infoTips(JSON.stringify(e))}})):(bsTips("原密码输入错误，请重新输入"),void $('input[name="oldPsw"]').focus())}),$('[name="clearPsw"]').on("click",function(){$('form[name="userPsw"] input').val("")});(function(){$('form[name="userPsw"]').validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:{oldPsw:{required:!0},newPsw:{required:!0,minlength:5},rptPsw:{equalTo:"[name='newPsw']"}},messages:{oldPsw:{required:"原密码不能为空."},newPsw:{required:"密码不能为空."},rptPsw:{required:"密码不能为空."}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}})})()}();jQuery(document).ready(function(){initDom(),UIIdleTimeout.init(),handleAvatar.init(),handleBasicInfo.init()}),jQuery(window).resize(function(){HeadFix()});