var DBSourse=[{value:0,text:"质量综合管理系统"},{value:1,text:"小张核查"},{value:2,text:"码后核查"},{value:3,text:"机台作业"},{value:4,text:"库管系统"},{value:5,text:"质量控制中心"},{value:6,text:"号码三合一系统"},{value:7,text:"在线清数"},{value:8,text:"办公小助手"},{value:9,text:"钞纸在线质量检测"},{value:10,text:"质量图像数据库"},{value:11,text:"数据共享平台"},{value:12,text:"检封装箱数据库"}],isInited=!1,apiList=function(){function e(e){var t=o.fnAddData([e.ApiID,e.AuthorName,e.DBName,e.ApiName,e.strSQL,e.params,'<a class="edit" href="javascript:;" data-apiid="'+e.ApiID+'" data-sn="'+e.newID+'">编辑</a>','<a class="delete" href="javascript:;" data-sn="'+e.newID+'">删除</a>']);o.fnGetNodes(t[0])}function t(e,t){for(var a=e.fnGetData(t),i=$(">td",t),n=0,o=i.length;n<o;n++)e.fnUpdate(a[n],t,n,!1);e.fnDraw()}function a(e,t){var a=e.fnGetData(t),i=$(">td",t),n=DBSourse.map(function(e){var t=a[2]==e.text?"selected":"";return"<option value="+e.id+" "+t+">"+e.text+"</option>"});i[2].innerHTML='<select class="form-control input-md input-inline" name="dblist">'+n+"</select>",i[3].innerHTML='<input type="text" class="form-control" value="'+a[3]+'">',i[4].innerHTML='<input type="text" class="form-control input-md" value="'+a[4]+'">',i[5].innerHTML='<input type="text" class="form-control" value="'+a[5]+'">',i[6].innerHTML='<a class="edit" href="javascript:;" data-apiid="'+a[0]+'" data-sn="'+l+'">保存</a>',i[7].innerHTML='<a class="cancel" href="javascript:;" data-sn="'+l+'">取消</a>'}function i(e,t){var a=$("input",t),i=$(">td",t)[0].innerHTML.replace(/[^0-9]/g,""),n=$("#url").attr("href").split("=")[1].split("&")[0],o="id_"+i+"_token_"+n,r={ApiName:a[0].value,strSQL:$.base64.encode(a[1].value),Params:a[2].value,utf2gbk:["ApiName","Params"],id:l,tbl:TBL.API,DBID:$('[name="dblist"] :selected').val(),cacheName:o};if(""!==r.ApiName&&""!==r.strSQL){e.fnUpdate($('[name="dblist"] :selected').text(),t,2,!1),e.fnUpdate(a[0].value,t,3,!1),e.fnUpdate(a[1].value,t,4,!1),e.fnUpdate(a[2].value,t,5,!1),e.fnUpdate('<a class="edit" href="javascript:;" data-apiid="'+a[1].value+'" data-sn="'+l+'">编辑</a>',t,6,!1),e.fnUpdate('<a class="delete" href="javascript:;" data-apiid="'+a[1].value+'" data-sn="'+l+'">删除</a>',t,7,!1),e.fnDraw();var s=getRootPath()+"/DataInterface/update";$.post(s,r,function(e){var t=$.parseJSON(e);infoTips(t.message,t.type)})}else bsTips("接口名及查询语句不能为空")}var n,o,l,r=$(".top-menu .username").text().trim(),s=getRootPath(1)+"/DataInterface/Api?ID=0&author="+r+"&cache=1440",d=$("#apiList"),c=null,p=function(){d.on("click",".edit",function(e){l=$(this).data("sn"),e.preventDefault();var n=$(this).parents("tr")[0];null!==c&&c!=n?(t(o,c),a(o,n),c=n):c==n&&"保存"==this.innerHTML?(i(o,c),c=null):(a(o,n),c=n,$(this).text("保存"),$(this).parent().parent().find("a:eq(1)").text("取消"),$(this).parent().parent().find("a:eq(1)").removeClass("delete"),$(this).parent().parent().find("a:eq(1)").addClass("cancel"))}),d.on("click",".delete",function(e){e.preventDefault();var t=$(this),a=$(">td",nRow)[0].innerHTML.replace(/[^0-9]/g,""),i=$("#url").attr("href").split("=")[1].split("&")[0],n="id_"+a+"_token_"+i;bootbox.dialog({message:"确定删除这条信息?",title:"删除信息",buttons:{success:{label:"删除",className:"green",callback:function(){var e=getRootPath()+"/DataInterface/delete";$.post(e,{id:t.data("sn"),tbl:TBL.API,cacheName:n},function(e){var a=t.parents("tr")[0];o.fnDeleteRow(a),infoTips("数据成功删除",1);var i=$(".top-menu .username").text().trim(),n=ReadData(getRootPath()+"/DataInterface/Api?Token"+config.TOKEN+"&ID=29&M=3&author="+i);$("#ApiID").text(n.data[0])})}},main:{label:"取消",className:"red",callback:function(){}}}})}),d.on("click",".cancel",function(e){e.preventDefault(),t(o,c),c=null})};return{init:function(){isInited||$.ajax({url:s}).done(function(e){isInited=!0,e=$.parseJSON(e),e.data.map(function(t,a){e.data[a][5]=$.base64.decode(t[5])});var t=CreateTableBody(e,!0);$("#apiList tbody").html(t);var a=0;App.getViewPort().width<App.getResponsiveBreakpoint("md")?$(".page-header").hasClass("page-header-fixed-mobile")&&(a=$(".page-header").outerHeight(!0)):$(".page-header").hasClass("navbar-fixed-top")&&(a=$(".page-header").outerHeight(!0)),n={bRetrieve:!0,language:dtLanguage,order:[[1,"asc"]],lengthMenu:[[5,10,15,20,50,100,-1],[5,10,15,20,50,100,"All"]],pageLength:15,dom:"<'clear'>R<'row tbTools' <'col-md-12'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r><'table-scrollable't><'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",bDeferRender:!0,bProcessing:!0,bStateSave:!0,bserverSide:!1,bInfo:!0,bAutoWidth:!0,bSortClasses:!1,bScrollInfinite:!0,searchHighlight:!0,scroolY:"70v",scrollCollapse:!0,initComplete:function(){$("#apiList_tools").append($("#apiList").parent().find(".tabletools-btn-group").clone(!0)),$("#apiList").parent().find(".tabletools-btn-group").remove()}},o=d.dataTable(n),p()})},newRow:function(t){e(t)}}}(),dataTable=function(){function e(e){var t;return t={bRetrieve:!0,language:dtLanguage,order:[[1,"asc"]],lengthMenu:[[5,10,15,20,50,100,-1],[5,10,15,20,50,100,"All"]],pageLength:15,dom:"<'row tbTools' <'col-md-6 col-sm-12 pull-right'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>>t<'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",bDeferRender:!0,bProcessing:!0,bStateSave:!0,bserverSide:!1,bInfo:!0,bAutoWidth:!0,bSortClasses:!1,aoColumns:e.header,data:e.data,bScrollInfinite:!0,searchHighlight:!0,fixedHeader:{header:!(e.cols>20),footer:!(e.cols>20),headerOffset:e.fixedHeaderOffset},scroolY:"70v",scrollCollapse:!0,initComplete:function(){var t=this.api();t.$("td").on("click",function(){t.search(this.innerText).draw()}),$(e.tblID+"_tools").append($(e.tblID).parent().find(".tabletools-btn-group").clone(!0)),$(e.tblID).parent().find(".tabletools-btn-group").remove()}}}function t(t,a){var n=$(t),o=0;App.getViewPort().width<App.getResponsiveBreakpoint("md")?$(".page-header").hasClass("page-header-fixed-mobile")&&(o=$(".page-header").outerHeight(!0)):$(".page-header").hasClass("navbar-fixed-top")&&(o=$(".page-header").outerHeight(!0)),a.fixedHeaderOffset=o,a.tblID=t;var l=e(a);i=n.dataTable(l)}function a(e,a){var n=$(e);if(Data=ReadData(a),$(e+"_TableTitle").text(Data.title),$(e+"_datasource").text("("+Data.source+")"),Data.cols<2)return void infoTips("请确保数据列在2列以上，当前为："+Data.cols);if(!(Data.rows>0))return void infoTips("该时间范围内无数据，请重新选择查询时间!",1);if(!$("#sample tbody").length)return void t(e,Data);i=n.dataTable(),i.fnClearTable(this);for(var o=i.fnSettings(),l=0;l<Data.rows;l++)i.oApi._fnAddData(o,Data.data[l]);o.aiDisplay=o.aiDisplayMaster.slice(),i.fnDraw()}var i;return{init:function(){$("#Preview").on("click",function(){var e=$("#PreviewUrl").val();a("#sample",e)}),$("#viewAPI").on("click",function(){apiList.init()})},RefreshTable:function(e,t){a(e,t)},newRow:function(e){apiList.newRow(e)}}}(),FormEditable=function(){$.mockjaxSettings.responseTime=100;var e=function(){$.mockjax({url:"/post"}),$.mockjax({url:"/DBGroups",response:function(e){this.responseText=DBSourse}})},t=function(){var e=$("#InputInner").bootstrapSwitch("state")===!0?1:0;e&&($.fn.editable.defaults.mode="inline"),$.fn.editable.defaults.inputclass="form-control",$.fn.editable.defaults.url="/post",$("#ApiName").editable({validate:function(e){if(""===$.trim(e))return"该字段不能为空"},type:"text",pk:1,name:"ApiName",title:"请输入接口名称"}),$("#Token").editable({validate:function(e){if(""===$.trim(e))return"该字段不能为空"}}),$("#DataBaseID").editable({name:"DBID",inputclass:"form-control input-md",source:DBSourse}),$("#CreateDate").editable({format:"yyyy-mm-dd hh:ii",viewformat:"yyyy-mm-dd hh:ii",datetimepicker:{rtl:App.isRTL(),todayBtn:"linked",weekStart:1}}),$("#SQL").editable({name:"strSQL",showbuttons:"bottom",rows:8,inputclass:"form-control",tpl:'<textarea style="min-width:350px;"></textarea>',validate:function(e){if(""===$.trim(e))return"该字段不能为空"}}),$("#note").editable({showbuttons:App.isRTL()?"left":"right",name:"ApiDesc"}),$("#pencil").on("click",function(e){e.stopPropagation(),e.preventDefault(),$("#note").editable("toggle")}),$("#url").editable({name:"URL",disabled:!0}),$("#ApiID").editable({disabled:!0})};return{init:function(){e(),t(),$("#edit").on("click",function(){$("#user .editable").editable("toggleDisabled"),$("#url").editable("disable"),$("#ApiID").editable("disable")}),$("#InputInner").on("switchChange.bootstrapSwitch",function(e){SaveSettings(),window.location.reload()}),$("#user .editable").on("hidden",function(e,t){if("save"===t||"nochange"===t){var a=$(this).closest("tr").next().find(".editable"),i=$("#InputToggle").bootstrapSwitch("state")===!0?1:0;i?setTimeout(function(){a.editable("show")},TBL.API0):a.focus()}}),$("#SaveAPI,#saves").on("click",function(){var e=getRootUrl("DataInterface")+"SaveAPI",t=$("#user .editable").editable("getValue");if(""===t.ApiName||""===t.strSQL||""===t.params)return void infoTips("接口名、查询语句以及接口参数不允许为空,请检查后重新提交",1);t.params=$("#params").val().split(",");var a=$("#DataBaseID").text().trim();$.post(e,t,function(e){var i=jQuery.parseJSON(e);if(infoTips(i.message,1),i.status){$("#Reset").click(),$("#ApiID").editable("setValue",i.NewID);var n="&ID="+t.ApiID,o=parseInt(t.ApiID,10)+1,l="&ID="+o,r=t.URL.replace(n,l);$("#url").editable("setValue",r),$("#DemoUrl").text(r),$("#DemoUrl").attr("href",r),isInited&&(t.newID=i.ID,t.AuthorName=$("#AuthorName").text().trim(),t.DBName=a,dataTable.newRow(t))}})}),$("#Reset").on("click",function(){$("#ApiName").editable("setValue",null).editable("option","pk",null).removeClass("editable-unsaved"),$("#SQL").editable("setValue",null).editable("option","pk",null).removeClass("editable-unsaved");var e='[功能说明]<p style="text-indent:2em;">本接口主要用于 <i>XX</i> 信息的查询.</p>[主要参数]';e+="<ul><li>TimeStart:开始时间；</li><li> TimeEnd:开始时间；</li><li> Cols:1/0,默认为空，设为1时返回查询语句的列用于表格初始化等操作；</li></ul>",$("#note").editable("setValue",e).editable("option","pk",null).removeClass("editable-unsaved")}),$("#clrCache").on("click",function(){$.ajax({url:getRootPath(1)+"/DataInterface/clearCache"})}),$('a[href="#portlet_tab1"]').on("click",function(){$('.portlet[name="api_View"]').hide(),window.onscroll=function(){$('table[aria-describedby="apiList_info"] thead tr[role="row"]:nth(1)').show(),$('table[aria-describedby="sample_info"] thead tr[role="row"]:nth(1)').hide()}}),$('a[href="#portlet_tab2"]').on("click",function(){$('.portlet[name="api_View"]').show(),window.onscroll=function(){$('table[aria-describedby="apiList_info"] thead tr[role="row"]:nth(1)').hide(),$('table[aria-describedby="sample_info"] thead tr[role="row"]:nth(1)').show()}}),$(document).on("blur",".bootstrap-tagsinput",function(){$(this).css({"background-color":$(".bootstrap-tagsinput").parent().css("background-color"),border:"none","box-shadow":"none"})}),$(document).on("focus",".bootstrap-tagsinput",function(){$(".bootstrap-tagsinput").removeAttr("style")})}}}();jQuery(document).ready(function(){initDashboardDaterange("YYYYMMDD"),$("#CreateDate").text(today(3)),initDom(),$(".page-header .dropdown-quick-sidebar-toggler").hide(),dataTable.init(),FormEditable.init()}),jQuery(window).resize(function(){HeadFix()});